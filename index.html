<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cath Lab Inventory Search (Excel-powered)</title>
  <style>
    #map-container { position: relative; display: inline-block; }
    #highlight-area { position: absolute; border: 3px solid red; pointer-events: none; display: none; animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0; } }
    #matches button { display: block; margin: 5px 0; }
    #comments { margin-top: 10px; font-style: italic; }
    #search { width: 420px; height: 34px; font-size: 16px; padding: 6px 10px; }
    h1 { margin: 10px 0 6px; }
    .status { margin: 6px 0 10px; font-size: 0.95rem; color: #555; }
    .hidden { display:none; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <h1>Cath Lab Inventory Search</h1>
  <div class="status" id="status">Loading inventory.xlsx…</div>
  <input type="text" id="search" placeholder="Search by Description, ReferenceNo, or APC_CODE" disabled>
  <div id="matches"></div>
  <div id="result"></div>
  <div id="comments"><strong>Comments:</strong> <span id="comment-text">None</span></div>

  <div id="map-container">
    <img id="labMap" src="VGH Cath Lab Room Numbers.jpg" usemap="#image-map" alt="Cath Lab Map">
    <div id="highlight-area"></div>
    <map name="image-map">
      <!-- keep your imagemap areas as-is -->
    </map>
  </div>

<script>
const apcCodeMapping = {
  "Cart-A": {top: 142, left: 318, width: 34, height: 20},
  "Cart-B": {top: 110, left: 292, width: 27, height: 52},
  "Cart-C": {top: 63, left: 302, width: 19, height: 30},
  "Cart-D": {top: 62, left: 301, width: 18, height: 32},
  "Cart-E": {top: 65, left: 279, width: 22, height: 13},
  "Cart-F": {top: 65, left: 256, width: 24, height: 13},
  "Cart-G": {top: 61, left: 222, width: 34, height: 17},
  "Cart-H": {top: 108, left: 252, width: 14, height: 15},
  "Cart-I": {top: 123, left: 252, width: 14, height: 12},
  "Cart-J": {top: 134, left: 252, width: 13, height: 14},
  "Cart-K": {top: 149, left: 252, width: 12, height: 13},
  "Cart-L": {top: 107, left: 275, width: 16, height: 55},
  "Cart-M": {top: 108, left: 239, width: 13, height: 12},
  "Cart-N": {top: 122, left: 239, width: 15, height: 14},
  "Cart-O": {top: 135, left: 238, width: 15, height: 12},
  "Cart-P": {top: 147, left: 239, width: 12, height: 16},
  "Cart-Q": {top: 145, left: 215, width: 11, height: 15},
  "Cart-R": {top: 127, left: 215, width: 11, height: 17},
  "Cart-S": {top: 108, left: 215, width: 11, height: 19},
  "Cart-T": {top: 415, left: 175, width: 13, height: 22},
  "Cart-U": {top: 439, left: 175, width: 14, height: 19},
  "Cart-V": {top: 458, left: 175, width: 16, height: 18},
  "Pacer":  {top: 391, left: 119, width: 69, height: 23},
  "TAVI-1": {top: 120, left: 125, width: 19, height: 23},
  "TAVI-2": {top: 5, left: 46, width: 30, height: 45},
  "Lab2": {top: 254, left: 122, width: 24, height: 27},
  "G549":  {top: 112, left: 175, width: 39, height: 33},
  "G550A": {top: 66, left: 172, width: 47, height: 40},
  "CRU":   {top: 152, left: 176, width: 35, height: 54},
  "Dirty": {top: 334, left: 345, width: 83, height: 35},
};

let inventoryData = [];
const searchInput = document.getElementById('search');
const matchesDiv = document.getElementById('matches');
const resultDiv = document.getElementById('result');
const commentText = document.getElementById('comment-text');
const highlightArea = document.getElementById('highlight-area');
const statusEl = document.getElementById('status');

function normKey(row, key) {
  if (row[key] !== undefined) return row[key];
  const candidates = [key.toUpperCase(), key.toLowerCase(), key[0].toUpperCase() + key.slice(1).toLowerCase()];
  for (const c of candidates) {
    if (row[c] !== undefined) return row[c];
  }
  const found = Object.keys(row).find(k => k.toLowerCase() === key.toLowerCase());
  return found ? row[found] : "";
}

function normalizeRow(row) {
  return {
    DESCRIPTION: String(normKey(row, 'DESCRIPTION') || normKey(row, 'Description') || '').trim(),
    ReferenceNo: String(normKey(row, 'ReferenceNo') || normKey(row, 'Reference') || normKey(row, 'Ref') || '').trim(),
    APC_CODE: String(normKey(row, 'APC_CODE') || normKey(row, 'APC') || '').trim(),
    COMMENT: String(normKey(row, 'COMMENT') || normKey(row, 'Comment') || '').trim(),
  };
}

function pickSheetWithHeaders(wb) {
  // Prefer a sheet literally named "Inventory"
  const prefer = wb.SheetNames.find(n => n.toLowerCase() === 'inventory');
  if (prefer) return wb.Sheets[prefer];
  // Otherwise scan for a sheet with likely headers
  for (const name of wb.SheetNames) {
    const ws = wb.Sheets[name];
    const rows = XLSX.utils.sheet_to_json(ws, { header: 1, blankrows: false });
    const first = (rows[0] || []).map(v => String(v || '').toLowerCase().trim());
    const score = ['description','referenceno','apc_code','comment'].filter(h => first.includes(h)).length;
    if (score >= 2) return ws;
  }
  // Fallback to first
  return wb.Sheets[wb.SheetNames[0]];
}

async function loadExcel() {
  try {
    const res = await fetch('inventory.xlsx', { cache: 'no-store' });
    if (!res.ok) throw new Error('Could not fetch inventory.xlsx (' + res.status + ')');
    const arrayBuf = await res.arrayBuffer();
    const wb = XLSX.read(arrayBuf, { type: 'array' });
    const ws = pickSheetWithHeaders(wb);
    const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
    inventoryData = rows.map(normalizeRow).filter(r => r.DESCRIPTION || r.ReferenceNo || r.APC_CODE);
    statusEl.textContent = 'Inventory loaded: ' + inventoryData.length + ' items';
    searchInput.disabled = false;
    searchInput.focus();
  } catch (err) {
    console.error(err);
    statusEl.textContent = 'Failed to load inventory.xlsx. You can also use the file picker below.';
    document.getElementById('picker-wrap').classList.remove('hidden');
  }
}

async function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const data = await file.arrayBuffer();
  const wb = XLSX.read(data, { type: 'array' });
  const ws = pickSheetWithHeaders(wb);
  const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
  inventoryData = rows.map(normalizeRow).filter(r => r.DESCRIPTION || r.ReferenceNo || r.APC_CODE);
  statusEl.textContent = 'Loaded from file: ' + file.name + ' — ' + inventoryData.length + ' items';
  searchInput.disabled = false;
  searchInput.focus();
}

searchInput.addEventListener('input', () => {
  const query = searchInput.value.trim().toLowerCase();
  const results = inventoryData.filter(item => {
    const desc = (item.DESCRIPTION || '').toLowerCase();
    const ref  = (item.ReferenceNo || '').toLowerCase();
    const apc  = (item.APC_CODE || '').toLowerCase();
    return desc.includes(query) || ref.includes(query) || apc.includes(query);
  });

  matchesDiv.innerHTML = '<strong>Matching Items:</strong><br>';
  highlightArea.style.display = 'none';

  if (results.length) {
    results.forEach(result => {
      const button = document.createElement('button');
      button.textContent = `${result.DESCRIPTION} (Ref: ${result.ReferenceNo})`;
      button.addEventListener('click', () => {
        resultDiv.innerHTML = `<strong>Description:</strong> ${result.DESCRIPTION}<br>
                               <strong>Reference No:</strong> ${result.ReferenceNo}<br>
                               <strong>Location:</strong> ${result.APC_CODE}`;
        commentText.textContent = result.COMMENT || 'No comments.';
        const coords = apcCodeMapping[result.APC_CODE];
        if (coords) {
          highlightArea.style.top = coords.top + 'px';
          highlightArea.style.left = coords.left + 'px';
          highlightArea.style.width = coords.width + 'px';
          highlightArea.style.height = coords.height + 'px';
          highlightArea.style.display = 'block';
        } else {
          highlightArea.style.display = 'none';
        }
      });
      matchesDiv.appendChild(button);
    });
  } else if (query.length) {
    matchesDiv.innerHTML = 'Item not found';
    resultDiv.innerHTML = '';
    commentText.textContent = 'None';
  } else {
    matchesDiv.innerHTML = '';
    resultDiv.innerHTML = '';
    commentText.textContent = 'None';
  }
});

loadExcel();
</script>

<div id="picker-wrap" class="hidden" style="margin-top:10px;">
  <label>Or load an Excel file: <input type="file" id="filePicker" accept=".xlsx,.xls" /></label>
</div>
<script>
  document.getElementById('filePicker').addEventListener('change', handleFile);
</script>
</body>
</html>
